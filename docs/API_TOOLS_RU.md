# Инструменты API AI Hedge Fund

## Общее описание
Модуль инструментов API предоставляет унифицированный интерфейс для работы с финансовыми данными через API Financial Datasets. Модуль включает в себя кэширование данных, валидацию и преобразование форматов.

## Основные функции

### 1. Работа с ценами (`get_prices`)
```python
def get_prices(ticker: str, start_date: str, end_date: str) -> list[Price]
```
#### Описание
- Получает исторические данные о ценах акций
- Поддерживает кэширование
- Автоматически фильтрует по датам

#### Параметры
- `ticker`: Тикер акции (например, "AAPL")
- `start_date`: Начальная дата в формате "YYYY-MM-DD"
- `end_date`: Конечная дата в формате "YYYY-MM-DD"

#### Возвращаемые данные
Список объектов `Price` с полями:
- `open`: Цена открытия
- `close`: Цена закрытия
- `high`: Максимальная цена
- `low`: Минимальная цена
- `volume`: Объем торгов
- `time`: Временная метка

### 2. Финансовые метрики (`get_financial_metrics`)
```python
def get_financial_metrics(
    ticker: str,
    end_date: str,
    period: str = "ttm",
    limit: int = 10
) -> list[FinancialMetrics]
```
#### Описание
- Получает финансовые показатели компании
- Поддерживает различные периоды отчетности
- Включает кэширование результатов

#### Параметры
- `ticker`: Тикер компании
- `end_date`: Конечная дата
- `period`: Период ("ttm" - trailing twelve months, "q" - quarterly)
- `limit`: Максимальное количество записей

### 3. Инсайдерские сделки (`get_insider_trades`)
```python
def get_insider_trades(
    ticker: str,
    end_date: str,
    start_date: str | None = None,
    limit: int = 1000
) -> list[InsiderTrade]
```
#### Описание
- Получает данные об инсайдерских сделках
- Поддерживает пагинацию для больших объемов данных
- Автоматически объединяет результаты нескольких запросов

#### Особенности
- Автоматическая пагинация
- Фильтрация по датам
- Сортировка по дате транзакции

### 4. Новости компаний (`get_company_news`)
```python
def get_company_news(
    ticker: str,
    end_date: str,
    start_date: str | None = None,
    limit: int = 1000
) -> list[CompanyNews]
```
#### Описание
- Получает новости о компании
- Включает анализ настроений (если доступно)
- Поддерживает фильтрацию по датам

### 5. Поиск статей отчетности (`search_line_items`)
```python
def search_line_items(
    ticker: str,
    line_items: list[str],
    end_date: str,
    period: str = "ttm",
    limit: int = 10
) -> list[LineItem]
```
#### Описание
- Поиск конкретных статей в финансовой отчетности
- Поддержка различных типов отчетности
- Гибкий поиск по названиям статей

## Вспомогательные функции

### 1. Конвертация в DataFrame
```python
def prices_to_df(prices: list[Price]) -> pd.DataFrame
```
#### Описание
- Преобразует список цен в pandas DataFrame
- Устанавливает временной индекс
- Оптимизирует типы данных

### 2. Получение рыночной капитализации
```python
def get_market_cap(ticker: str, end_date: str) -> float
```
#### Описание
- Получает текущую рыночную капитализацию
- Использует последние доступные данные
- Поддерживает кэширование

## Особенности реализации

### 1. Кэширование
```python
# Пример работы с кэшем
if cached_data := _cache.get_prices(ticker):
    filtered_data = [Price(**price) for price in cached_data 
                    if start_date <= price["time"] <= end_date]
    if filtered_data:
        return filtered_data
```
#### Механизм работы
- Проверка наличия данных в кэше
- Фильтрация закэшированных данных
- Автоматическое обновление кэша

### 2. Обработка ошибок
```python
if response.status_code != 200:
    raise Exception(f"Error fetching data: {response.status_code} - {response.text}")
```
#### Особенности
- Проверка статуса ответа
- Информативные сообщения об ошибках
- Сохранение контекста ошибки

### 3. Валидация данных
- Использование Pydantic моделей
- Автоматическая проверка типов
- Преобразование форматов

## Примеры использования

### 1. Получение исторических цен
```python
# Получение цен акций Apple за последний месяц
prices = get_prices(
    ticker="AAPL",
    start_date="2025-01-14",
    end_date="2025-02-14"
)
# Преобразование в DataFrame
df = prices_to_df(prices)
```

### 2. Анализ финансовых показателей
```python
# Получение финансовых метрик
metrics = get_financial_metrics(
    ticker="AAPL",
    end_date="2025-02-14",
    period="ttm"
)
# Анализ P/E
for metric in metrics:
    print(f"P/E: {metric.price_to_earnings_ratio}")
```

### 3. Мониторинг инсайдерских сделок
```python
# Получение последних инсайдерских сделок
trades = get_insider_trades(
    ticker="AAPL",
    end_date="2025-02-14",
    limit=10
)
# Анализ крупных сделок
for trade in trades:
    if trade.transaction_value and trade.transaction_value > 1000000:
        print(f"Крупная сделка: {trade.transaction_value:,.2f}")
```

## Рекомендации по использованию

### 1. Оптимизация запросов
- Используйте кэширование для частых запросов
- Ограничивайте временной диапазон
- Устанавливайте разумные лимиты

### 2. Обработка ошибок
- Всегда обрабатывайте исключения
- Проверяйте наличие API ключа
- Валидируйте входные параметры

### 3. Работа с данными
- Используйте типизированные объекты
- Проверяйте полноту данных
- Учитывайте возможные пропуски

## Ограничения

1. **API лимиты**
   - Ограничения на количество запросов
   - Лимиты на объем данных
   - Временные ограничения

2. **Данные**
   - Задержка в обновлении
   - Возможные пропуски
   - Ограничения по историческим данным

3. **Технические**
   - Зависимость от внешнего API
   - Требования к памяти при кэшировании
   - Ограничения на параллельные запросы

## Планы по улучшению

1. **Функциональность**
   - Добавление новых типов данных
   - Расширение возможностей фильтрации
   - Улучшение обработки ошибок

2. **Производительность**
   - Оптимизация кэширования
   - Улучшение пагинации
   - Параллельные запросы

3. **Удобство использования**
   - Расширение документации
   - Добавление примеров
   - Улучшение типизации
