# Risk Manager Agent

## Общее описание
Risk Manager Agent - это специализированный агент, отвечающий за управление рисками и определение размеров позиций на основе реальных рыночных факторов. Агент контролирует размер каждой позиции в портфеле, обеспечивая соблюдение установленных лимитов риска и диверсификацию портфеля.

## Основные компоненты

### 1. Анализ портфеля
```python
# Расчет стоимости портфеля
total_portfolio_value = portfolio.get("cash", 0) + 
    sum(portfolio.get("cost_basis", {}).get(t, 0) 
    for t in portfolio.get("cost_basis", {}))
```

### 2. Лимиты позиций
- Базовый лимит: 20% от стоимости портфеля для любой отдельной позиции
- Учет существующих позиций при расчете доступного лимита
- Ограничение доступными денежными средствами

## Процесс анализа рисков

### 1. Сбор данных
```python
# Получение ценовых данных
prices = get_prices(
    ticker=ticker,
    start_date=data["start_date"],
    end_date=data["end_date"]
)
prices_df = prices_to_df(prices)
```

### 2. Расчет лимитов
```python
# Базовый лимит позиции
position_limit = total_portfolio_value * 0.20

# Оставшийся лимит
remaining_position_limit = position_limit - current_position_value

# Максимальный размер позиции
max_position_size = min(remaining_position_limit, portfolio.get("cash", 0))
```

## Выходные данные

### 1. Структура анализа рисков
```python
risk_analysis = {
    "ticker": {
        "remaining_position_limit": float,  # Оставшийся лимит позиции
        "current_price": float,            # Текущая цена
        "reasoning": {
            "portfolio_value": float,      # Общая стоимость портфеля
            "current_position": float,     # Текущий размер позиции
            "position_limit": float,       # Лимит позиции
            "remaining_limit": float,      # Оставшийся лимит
            "available_cash": float        # Доступные средства
        }
    }
}
```

### 2. Пример вывода
```python
{
    "AAPL": {
        "remaining_position_limit": 50000.0,
        "current_price": 150.0,
        "reasoning": {
            "portfolio_value": 500000.0,
            "current_position": 50000.0,
            "position_limit": 100000.0,
            "remaining_limit": 50000.0,
            "available_cash": 100000.0
        }
    }
}
```

## Особенности реализации

### 1. Обработка данных
- Проверка наличия ценовых данных
- Конвертация в DataFrame для анализа
- Хранение текущих цен для оптимизации

### 2. Расчеты
- Учет текущих позиций
- Проверка доступных средств
- Расчет оставшихся лимитов

### 3. Мониторинг
```python
progress.update_status("risk_management_agent", ticker, "status_message")
```

## Ограничения

### 1. Риск-метрики
- Фиксированный лимит в 20%
- Отсутствие динамических лимитов
- Ограниченный набор риск-метрик

### 2. Данные
- Зависимость от качества ценовых данных
- Отсутствие исторической волатильности
- Ограниченный временной горизонт

### 3. Методология
- Упрощенная модель риска
- Отсутствие корреляционного анализа
- Ограниченный учет рыночных условий

## Рекомендации по использованию

### 1. Настройка параметров
- Адаптация лимитов позиций
- Настройка риск-метрик
- Калибровка ограничений

### 2. Мониторинг рисков
- Регулярный анализ позиций
- Отслеживание концентрации риска
- Контроль использования лимитов

### 3. Интеграция
- Взаимодействие с Portfolio Manager
- Учет сигналов других агентов
- Координация торговых решений

## Планы по улучшению

### 1. Расширение риск-метрик
- Добавление VaR (Value at Risk)
- Анализ корреляций
- Стресс-тестирование

### 2. Улучшение методологии
- Динамические лимиты позиций
- Адаптивное управление рисками
- Улучшенный анализ портфеля

### 3. Оптимизация
- Улучшенное кэширование данных
- Параллельная обработка
- Оптимизация расчетов

## Интеграция с другими агентами

### 1. Portfolio Manager
- Предоставление лимитов позиций
- Контроль размера сделок
- Обеспечение соблюдения ограничений

### 2. Technical Agent
- Учет технических индикаторов
- Анализ волатильности
- Оценка рыночных рисков

### 3. Fundamental Agent
- Учет фундаментальных факторов
- Оценка качества компаний
- Анализ секторных рисков

## Безопасность и контроль

### 1. Проверки данных
- Валидация входных данных
- Проверка расчетов
- Контроль ограничений

### 2. Логирование
```python
if state["metadata"]["show_reasoning"]:
    show_agent_reasoning(risk_analysis, "Risk Management Agent")
```

### 3. Мониторинг состояния
- Отслеживание статуса операций
- Контроль ошибок
- Аудит решений
